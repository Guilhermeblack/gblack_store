{% extends "blocks/base.html" %}
{% load static %}
{% block conteudo %}

<section id="conta" class="section-bg">
  <div class="container" data-aos="fade-up">

    <div class="section-title">
      <h2>Minha Conta</h2>
      <p>Bem-vindo, {{ usuario.first_name|default:usuario.email }}</p>
    </div>

    <div class="row">
      <!-- User Info & Store Status -->
      <div class="col-lg-4">
        <div class="card mb-4">
          <div class="card-body text-center">
            <img src="{% static 'img/logo.png' %}" alt="Avatar" class="rounded-circle img-fluid" style="width: 150px;">
            <h5 class="my-3">{{ usuario.first_name }} {{ usuario.last_name }}</h5>
            <p class="text-muted mb-1">{{ usuario.email }}</p>
            <p class="text-muted mb-4">Membro desde: {{ usuario.date_joined|date:"d/m/Y" }}</p>

            {% if not usuario.loja %}
            <div class="d-flex justify-content-center mb-2">
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="lojasim" value="sim">
                <button type="submit" class="btn btn-outline-primary">Quero vender na GBlack</button>
              </form>
            </div>
            {% else %}
            <span class="badge badge-success">Vendedor Verificado</span>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Orders & Store Management -->
      <div class="col-lg-8">

        <!-- Order History -->
        <div class="card mb-4">
          <div class="card-header">
            <h4>Meus Pedidos</h4>
          </div>
          <div class="card-body">
            {% if vendas %}
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Data</th>
                    <th>Total</th>
                    <th>Status</th>
                    <th>Detalhes</th>
                  </tr>
                </thead>
                <tbody>
                  {% for venda in vendas %}
                  <tr>
                    <td>{{ venda.id }}</td>
                    <td>{{ venda.created_at|date:"d/m/Y H:i" }}</td>
                    <td>R$ {{ venda.total }}</td>
                    <td>
                      <span
                        class="badge badge-{% if venda.status == 'PAID' %}success{% elif venda.status == 'PENDING' %}warning{% else %}secondary{% endif %}">
                        {{ venda.get_status_display }}
                      </span>
                    </td>
                    <td>
                      <button class="btn btn-sm btn-info" type="button" data-toggle="collapse"
                        data-target="#orderDetails{{ venda.id }}" aria-expanded="false"
                        aria-controls="orderDetails{{ venda.id }}">
                        Ver Itens
                      </button>
                    </td>
                  </tr>
                  <tr class="collapse" id="orderDetails{{ venda.id }}">
                    <td colspan="5">
                      <div class="card card-body">
                        <h6>Itens do Pedido:</h6>
                        <ul>
                          {% for item in venda.items.all %}
                          <li>{{ item.produto_nome }} - {{ item.quantidade }}x R$ {{ item.preco_unitario }}</li>
                          {% endfor %}
                        </ul>
                        {% if venda.address %}
                        <h6>Endereço de Entrega:</h6>
                        <p>{{ venda.address.street }}, {{ venda.address.number }} - {{ venda.address.city }}/{{
                          venda.address.state }}</p>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <p>Você ainda não fez nenhum pedido.</p>
            <a href="{% url 'index' %}" class="btn btn-primary">Ir às compras</a>
            {% endif %}
          </div>
        </div>

        <!-- Store Management (If Seller) -->
        {% if usuario.loja %}
        <div class="card mb-4">
          <div class="card-header">
            <h4>Gerenciar Produtos</h4>
          </div>
          <div class="card-body">

            <!-- Add Product Form -->
            <h5 class="card-title">Novo Produto</h5>
            <form action="{% url 'conta' %}" enctype="multipart/form-data" method="post" class="mb-4">
              {% csrf_token %}
              <input type="hidden" name="tipo" value="add_product">
              <!-- Helper to identify action if needed, though view checks 'tipo' field existence -->
              <div class="form-row">
                <div class="col-md-6 mb-3">
                  <input type="text" name="nome" class="form-control" placeholder="Nome do Produto" required>
                </div>
                <div class="col-md-6 mb-3">
                  <select name="tipo" class="form-control" required>
                    {% for code, name in prodtipo %}
                    <option value="{{ code }}">{{ name }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="form-row">
                <div class="col-md-4 mb-3">
                  <input type="number" name="preco" class="form-control" placeholder="Preço" step="0.01" required>
                </div>
                <div class="col-md-4 mb-3">
                  <input type="number" name="estoque" class="form-control" placeholder="Estoque" required>
                </div>
                <div class="col-md-4 mb-3">
                  <input type="file" name="img_prod" class="form-control-file" required>
                </div>
              </div>
              <div class="form-group">
                <textarea name="descricao" class="form-control" rows="3" placeholder="Descrição"></textarea>
              </div>
              <button type="submit" class="btn btn-success">Cadastrar Produto</button>
            </form>

            <hr>

            <!-- Product List -->
            <h5 class="card-title">Meus Produtos</h5>
            <div class="list-group">
              {% for p in produtos %}
              <!-- Note: This lists ALL products. Ideally should filter by seller if multi-vendor. Assuming single vendor or admin for now based on views.py -->
              <div class="list-group-item">
                <div class="d-flex w-100 justify-content-between">
                  <h5 class="mb-1">{{ p.nome }}</h5>
                  <small>Estoque: {{ p.estoque }}</small>
                </div>
                <p class="mb-1">{{ p.descricao|truncatechars:50 }}</p>
                <div class="d-flex justify-content-between align-items-center">
                  <small>R$ {{ p.preco }}</small>
                  <form method="post" action="{% url 'conta' %}" onsubmit="return confirm('Tem certeza?');">
                    {% csrf_token %}
                    <input type="hidden" name="exc_prod" value="{{ p.id }}">
                    <button type="submit" class="btn btn-danger btn-sm">Excluir</button>
                  </form>
                </div>
              </div>
              {% empty %}
              <p>Nenhum produto cadastrado.</p>
              {% endfor %}
            </div>

          </div>
        </div>
        {% endif %}

      </div>
    </div>

  </div>
</section>

{% endblock %}